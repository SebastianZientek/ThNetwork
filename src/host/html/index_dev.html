<!DOCTYPE HTML>
<html lang="en" data-theme="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>TESTING WEBPAGE</title>
    <meta name="description" content="A pure HTML example, without dependencies." />

    <!-- Pico.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.0.3/css/pico.min.css" />
    <script type="text/javascript" src="microChart.js"> </script>
</head>

<body>

    <header class="container">
        <nav>
            <ul></ul>
            <ul>
                <li><strong>TH network view</strong></li>
            </ul>
            <ul>
                <li><a href="/admin">Admin</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <!-- <div height="400px"> -->
        <article>
            <canvas class="chart" id="temperatureCanvas" width="100%" height="400px"></canvas>
        </article>
        <!-- </div> -->
        <article>
            <canvas class="chart" id="humidityCanvas" width="100%" height="400px"></canvas>
        </article>
    </main>

    <script type="application/javascript">
        const MAX_ARR_ELEMS = 220; // Should be send as configuration by server
        const TEMPERATURE_IDX = 1;
        const HUMIDITY_IDX = 2;

        var gData = {
            "2506682365": {
                "name": "Office",
                "values": [
                    [
                        1708629876,
                        23.67401123046875,
                        45.5963134765625
                    ],
                    [
                        1708629878,
                        23.675918579101562,
                        45.45145034790039
                    ],
                    [
                        1708629879,
                        23.660850524902344,
                        45.37496566772461
                    ],
                    [
                        1708629880,
                        23.662757873535156,
                        45.263671875
                    ],
                    [
                        1708629882,
                        23.66161346435547,
                        45.2117919921875
                    ],
                    [
                        1708629883,
                        23.66485595703125,
                        45.195579528808594
                    ],
                    [
                        1708629884,
                        23.647117614746094,
                        45.11423110961914
                    ],
                    [
                        1708629886,
                        23.682403564453125,
                        45.08466720581055
                    ],
                    [
                        1708629887,
                        23.65436553955078,
                        45.081520080566406
                    ],
                    [
                        1708629888,
                        23.662567138671875,
                        45.055580139160156
                    ],
                    [
                        1708629890,
                        23.65436553955078,
                        45.03650665283203
                    ],
                    [
                        1708629891,
                        23.659324645996094,
                        44.998836517333984
                    ],
                    [
                        1708629892,
                        23.669052124023438,
                        44.998931884765625
                    ],
                    [
                        1708629894,
                        23.66161346435547,
                        44.99921798706055
                    ],
                    [
                        1708629895,
                        23.66352081298828,
                        44.9986457824707
                    ],
                    [
                        1708629896,
                        23.672103881835938,
                        44.980812072753906
                    ],
                    [
                        1708629898,
                        23.66943359375,
                        44.9981689453125
                    ],
                    [
                        1708629899,
                        23.66180419921875,
                        44.976139068603516
                    ],
                    [
                        1708629900,
                        23.656654357910156,
                        44.94161605834961
                    ],
                    [
                        1708629902,
                        23.660850524902344,
                        44.916343688964844
                    ],
                    [
                        1708629903,
                        23.656845092773438,
                        44.9244499206543
                    ],
                    [
                        1708629904,
                        23.654937744140625,
                        44.90251541137695
                    ],
                    [
                        1708629906,
                        23.65436553955078,
                        44.88945007324219
                    ],
                    [
                        1708629907,
                        23.664474487304688,
                        44.957542419433594
                    ],
                    [
                        1708629908,
                        23.649978637695312,
                        44.93722915649414
                    ],
                    [
                        1708629910,
                        23.634719848632812,
                        44.96259689331055
                    ],
                    [
                        1708629911,
                        23.638916015625,
                        44.97251510620117
                    ],
                    [
                        1708629912,
                        23.64177703857422,
                        44.99044418334961
                    ],
                    [
                        1708629914,
                        23.644256591796875,
                        44.970703125
                    ],
                    [
                        1708629915,
                        23.645782470703125,
                        45.009803771972656
                    ],
                    [
                        1708629916,
                        23.65264892578125,
                        44.96803283691406
                    ],
                    [
                        1708629916,
                        23.65264892578125,
                        44.96803283691406
                    ],
                    [
                        1708629918,
                        23.64025115966797,
                        44.95038986206055
                    ],
                    [
                        1708629919,
                        23.639869689941406,
                        44.92988586425781
                    ],
                    [
                        1708629920,
                        23.634719848632812,
                        44.93513107299805
                    ],
                    [
                        1708629922,
                        23.651695251464844,
                        44.92654800415039
                    ],
                    [
                        1708629923,
                        23.625755310058594,
                        44.90203857421875
                    ],
                    [
                        1708629924,
                        23.64063262939453,
                        44.87485885620117
                    ],
                    [
                        1708629926,
                        23.64482879638672,
                        44.86351013183594
                    ],
                    [
                        1708629927,
                        23.642539978027344,
                        44.85187530517578
                    ],
                    [
                        1708629928,
                        23.64177703857422,
                        44.898223876953125
                    ],
                    [
                        1708629930,
                        23.617172241210938,
                        44.91748809814453
                    ],
                    [
                        1708629931,
                        23.616409301757812,
                        44.86494064331055
                    ],
                    [
                        1708629932,
                        23.650741577148438,
                        44.913673400878906
                    ],
                    [
                        1708629934,
                        23.615455627441406,
                        44.940757751464844
                    ],
                    [
                        1708629935,
                        23.625755310058594,
                        44.92654800415039
                    ],
                    [
                        1708629936,
                        23.612213134765625,
                        44.930171966552734
                    ],
                    [
                        1708629938,
                        23.624038696289062,
                        44.94285583496094
                    ],
                    [
                        1708629939,
                        23.621177673339844,
                        44.96173858642578
                    ],
                    [
                        1708629940,
                        23.61621856689453,
                        44.988250732421875
                    ],
                    [
                        1708629942,
                        23.62499237060547,
                        44.98329162597656
                    ],
                    [
                        1708629943,
                        23.62651824951172,
                        44.986820220947266
                    ],
                    [
                        1708629944,
                        23.60382080078125,
                        44.995689392089844
                    ],
                    [
                        1708629946,
                        23.60248565673828,
                        45.00083923339844
                    ],
                    [
                        1708629947,
                        23.612213134765625,
                        45.014190673828125
                    ],
                    [
                        1708629948,
                        23.615455627441406,
                        44.9951171875
                    ],
                    [
                        1708629950,
                        23.618507385253906,
                        45.0103759765625
                    ],
                    [
                        1708629951,
                        23.60992431640625,
                        44.994354248046875
                    ],
                    [
                        1708629952,
                        23.612213134765625,
                        45.021724700927734
                    ],
                    [
                        1708629954,
                        23.613929748535156,
                        45.04508972167969
                    ],
                    [
                        1708629955,
                        23.61583709716797,
                        45.055294036865234
                    ],
                    [
                        1708629956,
                        23.62213134765625,
                        45.078277587890625
                    ],
                    [
                        1708629958,
                        23.626136779785156,
                        45.09706497192383
                    ],
                    [
                        1708629959,
                        23.617172241210938,
                        45.05949020385742
                    ],
                    [
                        1708629960,
                        23.612594604492188,
                        45.04404067993164
                    ],
                    [
                        1708629962,
                        23.613548278808594,
                        45.06263732910156
                    ],
                    [
                        1708629963,
                        23.609542846679688,
                        45.046043395996094
                    ],
                    [
                        1708629964,
                        23.6175537109375,
                        45.041751861572266
                    ],
                    [
                        1708629966,
                        23.610877990722656,
                        45.04833221435547
                    ],
                    [
                        1708629967,
                        23.608016967773438,
                        45.072364807128906
                    ],
                    [
                        1708629968,
                        23.608016967773438,
                        45.046043395996094
                    ],
                    [
                        1708629970,
                        23.61297607421875,
                        45.029640197753906
                    ],
                    [
                        1708629971,
                        23.61297607421875,
                        45.04804611206055
                    ],
                    [
                        1708629972,
                        23.62232208251953,
                        45.07102966308594
                    ],
                    [
                        1708629974,
                        23.60401153564453,
                        45.061492919921875
                    ],
                    [
                        1708629975,
                        23.591041564941406,
                        45.08504867553711
                    ],
                    [
                        1708629976,
                        23.603057861328125,
                        45.07312774658203
                    ],
                    [
                        1708629978,
                        23.604965209960938,
                        45.07169723510742
                    ],
                    [
                        1708629979,
                        23.605728149414062,
                        45.06711959838867
                    ],
                    [
                        1708629980,
                        23.618507385253906,
                        45.07627487182617
                    ],
                    [
                        1708629982,
                        23.619842529296875,
                        45.079994201660156
                    ],
                    [
                        1708629983,
                        23.600387573242188,
                        45.06397247314453
                    ],
                    [
                        1708629984,
                        23.612213134765625,
                        45.050907135009766
                    ],
                    [
                        1708629986,
                        23.618125915527344,
                        45.055389404296875
                    ],
                    [
                        1708629987,
                        23.605728149414062,
                        45.07474899291992
                    ],
                    [
                        1708629988,
                        23.614501953125,
                        45.03507614135742
                    ],
                    [
                        1708629990,
                        23.619461059570312,
                        45.04661560058594
                    ],
                    [
                        1708629991,
                        23.601722717285156,
                        45.0495719909668
                    ],
                    [
                        1708629992,
                        23.606109619140625,
                        45.023536682128906
                    ],
                    [
                        1708629994,
                        23.62213134765625,
                        45.03488540649414
                    ],
                    [
                        1708629995,
                        23.62079620361328,
                        45.00541687011719
                    ],
                    [
                        1708629996,
                        23.61888885498047,
                        44.99502182006836
                    ],
                    [
                        1708629998,
                        23.61125946044922,
                        45.038509368896484
                    ],
                    [
                        1708629999,
                        23.601341247558594,
                        45.054054260253906
                    ],
                    [
                        1708630000,
                        23.601722717285156,
                        45.03517150878906
                    ],
                    [
                        1708630002,
                        23.60076904296875,
                        45.04518508911133
                    ],
                    [
                        1708630003,
                        23.628997802734375,
                        45.04079818725586
                    ],
                    [
                        1708630004,
                        23.613548278808594,
                        45.055580139160156
                    ],
                    [
                        1708630006,
                        23.62499237060547,
                        45.01914978027344
                    ],
                    [
                        1708630007,
                        23.60858917236328,
                        45.01628875732422
                    ],
                    [
                        1708630008,
                        23.6083984375,
                        45.01371383666992
                    ],
                    [
                        1708630010,
                        23.61907958984375,
                        45.04051208496094
                    ],
                    [
                        1708630011,
                        23.624420166015625,
                        44.957733154296875
                    ],
                    [
                        1708630012,
                        23.614120483398438,
                        44.99330520629883
                    ],
                    [
                        1708630014,
                        23.626708984375,
                        44.979286193847656
                    ],
                    [
                        1708630015,
                        23.61297607421875,
                        45.0169563293457
                    ],
                    [
                        1708630016,
                        23.606109619140625,
                        45.00465393066406
                    ],
                    [
                        1708630018,
                        23.612594604492188,
                        45.03202438354492
                    ],
                    [
                        1708630019,
                        23.624420166015625,
                        45.038414001464844
                    ],
                    [
                        1708630020,
                        23.618125915527344,
                        45.033931732177734
                    ],
                    [
                        1708630022,
                        23.626136779785156,
                        45.032596588134766
                    ],
                    [
                        1708630023,
                        23.606300354003906,
                        45.03068923950195
                    ],
                    [
                        1708630024,
                        23.620033264160156,
                        45.057010650634766
                    ],
                    [
                        1708630026,
                        23.62079620361328,
                        45.021915435791016
                    ],
                    [
                        1708630027,
                        23.61621856689453,
                        45.0688362121582
                    ],
                    [
                        1708630028,
                        23.629379272460938,
                        45.04661560058594
                    ],
                    [
                        1708630030,
                        23.617172241210938,
                        45.023345947265625
                    ],
                    [
                        1708630031,
                        23.626708984375,
                        45.0404167175293
                    ],
                    [
                        1708630032,
                        23.621368408203125,
                        45.041561126708984
                    ],
                    [
                        1708630034,
                        23.610687255859375,
                        45.06101608276367
                    ],
                    [
                        1708630035,
                        23.620033264160156,
                        45.09134292602539
                    ],
                    [
                        1708630036,
                        23.61583709716797,
                        45.06092071533203
                    ],
                    [
                        1708630037,
                        23.6175537109375,
                        45.0434684753418
                    ],
                    [
                        1708630039,
                        23.614883422851562,
                        45.046138763427734
                    ],
                    [
                        1708630040,
                        23.61907958984375,
                        45.01848220825195
                    ],
                    [
                        1708630041,
                        23.64063262939453,
                        45.017433166503906
                    ],
                    [
                        1708630043,
                        23.622703552246094,
                        44.99244689941406
                    ],
                    [
                        1708630044,
                        23.610877990722656,
                        45.000457763671875
                    ],
                    [
                        1708630045,
                        23.637962341308594,
                        44.99406814575195
                    ],
                    [
                        1708630047,
                        23.63300323486328,
                        45.00570297241211
                    ],
                    [
                        1708630048,
                        23.621749877929688,
                        44.99702453613281
                    ],
                    [
                        1708630049,
                        23.630332946777344,
                        44.99835968017578
                    ],
                    [
                        1708630051,
                        23.647117614746094,
                        44.99340057373047
                    ],
                    [
                        1708630052,
                        23.635292053222656,
                        45.01142501831055
                    ],
                    [
                        1708630053,
                        23.647499084472656,
                        44.96564865112305
                    ],
                    [
                        1708630055,
                        23.630714416503906,
                        44.94962692260742
                    ],
                    [
                        1708630056,
                        23.627471923828125,
                        44.985294342041016
                    ],
                    [
                        1708630057,
                        23.64349365234375,
                        44.971656799316406
                    ],
                    [
                        1708630059,
                        23.62232208251953,
                        44.9885368347168
                    ],
                    [
                        1708630060,
                        23.63433837890625,
                        44.991207122802734
                    ],
                    [
                        1708630061,
                        23.63147735595703,
                        44.982051849365234
                    ],
                    [
                        1708630063,
                        23.648452758789062,
                        44.97232437133789
                    ],
                    [
                        1708630063,
                        23.648452758789062,
                        44.97232437133789
                    ],
                    [
                        1708630064,
                        23.657608032226562,
                        44.934844970703125
                    ],
                    [
                        1708630065,
                        23.64940643310547,
                        44.927120208740234
                    ],
                    [
                        1708630067,
                        23.651695251464844,
                        44.86894607543945
                    ],
                    [
                        1708630068,
                        23.647117614746094,
                        44.837093353271484
                    ],
                    [
                        1708630069,
                        23.64025115966797,
                        44.82145309448242
                    ],
                    [
                        1708630071,
                        23.6602783203125,
                        44.82383728027344
                    ],
                    [
                        1708630072,
                        23.648452758789062,
                        44.876766204833984
                    ],
                    [
                        1708630073,
                        23.64025115966797,
                        44.84453201293945
                    ],
                    [
                        1708630075,
                        23.656845092773438,
                        44.83509063720703
                    ],
                    [
                        1708630076,
                        23.66504669189453,
                        44.85769271850586
                    ],
                    [
                        1708630077,
                        23.654556274414062,
                        44.869041442871094
                    ],
                    [
                        1708630079,
                        23.65264892578125,
                        44.87295150756836
                    ],
                    [
                        1708630080,
                        23.65436553955078,
                        44.849586486816406
                    ],
                    [
                        1708630081,
                        23.655319213867188,
                        44.82097625732422
                    ],
                    [
                        1708630083,
                        23.641586303710938,
                        44.843196868896484
                    ],
                    [
                        1708630084,
                        23.66352081298828,
                        44.873905181884766
                    ],
                    [
                        1708630085,
                        23.67725372314453,
                        44.86656188964844
                    ],
                    [
                        1708630087,
                        23.659324645996094,
                        44.87199783325195
                    ],
                    [
                        1708630088,
                        23.66943359375,
                        44.87752914428711
                    ],
                    [
                        1708630089,
                        23.667144775390625,
                        44.892215728759766
                    ],
                    [
                        1708630091,
                        23.6663818359375,
                        44.901466369628906
                    ],
                    [
                        1708630092,
                        23.650360107421875,
                        44.90642547607422
                    ],
                    [
                        1708630093,
                        23.66046905517578,
                        44.92912292480469
                    ],
                    [
                        1708630095,
                        23.638534545898438,
                        44.93389129638672
                    ],
                    [
                        1708630096,
                        23.68488311767578,
                        44.94314193725586
                    ],
                    [
                        1708630097,
                        23.670387268066406,
                        44.97098922729492
                    ],
                    [
                        1708630099,
                        23.665809631347656,
                        44.953346252441406
                    ],
                    [
                        1708630100,
                        23.65856170654297,
                        44.94762420654297
                    ],
                    [
                        1708630101,
                        23.670005798339844,
                        44.95105743408203
                    ],
                    [
                        1708630103,
                        23.67095947265625,
                        44.97690200805664
                    ],
                    [
                        1708630104,
                        23.673629760742188,
                        44.941139221191406
                    ],
                    [
                        1708630105,
                        23.665428161621094,
                        44.95868682861328
                    ],
                    [
                        1708630107,
                        23.678207397460938,
                        44.9650764465332
                    ],
                    [
                        1708630108,
                        23.671340942382812,
                        44.96288299560547
                    ],
                    [
                        1708630109,
                        23.666763305664062,
                        44.95220184326172
                    ],
                    [
                        1708630111,
                        23.682403564453125,
                        44.93131637573242
                    ],
                    [
                        1708630112,
                        23.68450164794922,
                        44.933223724365234
                    ],
                    [
                        1708630113,
                        23.66962432861328,
                        44.90976333618164
                    ],
                    [
                        1708630115,
                        23.675918579101562,
                        44.90041732788086
                    ],
                    [
                        1708630116,
                        23.68946075439453,
                        44.884490966796875
                    ],
                    [
                        1708630117,
                        23.67992401123047,
                        44.865989685058594
                    ],
                    [
                        1708630119,
                        23.680496215820312,
                        44.853878021240234
                    ],
                    [
                        1708630120,
                        23.696517944335938,
                        44.820404052734375
                    ],
                    [
                        1708630121,
                        23.674583435058594,
                        44.79074478149414
                    ],
                    [
                        1708630123,
                        23.683738708496094,
                        44.759273529052734
                    ],
                    [
                        1708630124,
                        23.662185668945312,
                        44.766807556152344
                    ],
                    [
                        1708630125,
                        23.680877685546875,
                        44.765663146972656
                    ],
                    [
                        1708630127,
                        23.677635192871094,
                        44.71254348754883
                    ],
                    [
                        1708630128,
                        23.67267608642578,
                        44.781494140625
                    ],
                    [
                        1708630129,
                        23.673057556152344,
                        44.76041793823242
                    ],
                    [
                        1708630131,
                        23.684120178222656,
                        44.73152160644531
                    ],
                    [
                        1708630132,
                        23.666763305664062,
                        44.765472412109375
                    ],
                    [
                        1708630133,
                        23.663902282714844,
                        44.76194381713867
                    ],
                    [
                        1708630135,
                        23.685455322265625,
                        44.736576080322266
                    ],
                    [
                        1708630136,
                        23.671722412109375,
                        44.74802017211914
                    ],
                    [
                        1708630137,
                        23.667144775390625,
                        44.730186462402344
                    ],
                    [
                        1708630139,
                        23.67267608642578,
                        44.74506378173828
                    ],
                    [
                        1708630140,
                        23.676681518554688,
                        44.704627990722656
                    ],
                    [
                        1708630141,
                        23.665809631347656,
                        44.698333740234375
                    ],
                    [
                        1708630143,
                        23.683547973632812,
                        44.72970962524414
                    ],
                    [
                        1708630144,
                        23.668670654296875,
                        44.72055435180664
                    ],
                    [
                        1708630145,
                        23.687744140625,
                        44.84891891479492
                    ],
                    [
                        1708630147,
                        23.68640899658203,
                        45.087528228759766
                    ]
                ]
            }
        };
        var gSensorIDsToNames = {
            "2506682365": "Office"
        };

        const temperatureCanvas = document.getElementById("temperatureCanvas");
        const temperatureChart = new MicroChart(temperatureCanvas, "Temperature");

        const humidityCanvas = document.getElementById("humidityCanvas");
        const humidityChart = new MicroChart(humidityCanvas, "Humidity");

        async function fetchSensorsIDToNameMapping() {
            const response = await fetch("sensorIDsToNames");
            const sensors = await response.json();
            return sensors;
        }

        async function initialFetchSensorsData() {
            gSensorIDsToNames = await fetchSensorsIDToNameMapping();
            console.log(gSensorIDsToNames);

            for (const [identifier, name] of Object.entries(gSensorIDsToNames)) {
                const dataResponse = await fetch('sensorData?' + new URLSearchParams({
                    "identifier": identifier
                }))

                const sensorData = await dataResponse.json();
                console.log(sensorData);

                setSensorData(sensorData, name);

                drawData(gData, temperatureChart, 0, 1);
                drawData(gData, humidityChart, 0, 2);
            }

        }

        function cleanupData(data) {
            for (const [identifier, payload] of Object.entries(data)) {
                let values = payload.values;

                values.sort((a, b) => a[0] - b[0]);
                let elemsToRemove = values.length - MAX_ARR_ELEMS;
                if (elemsToRemove > 0) {
                    data[identifier].values = values.slice(elemsToRemove);
                }

                const secInDay = 24 * 60 * 60;
                const currentEpoch = Math.round(Date.now() / 1000);
                const dayBeforeEpoch = currentEpoch - secInDay;

                data[identifier].values = data[identifier].values.filter((val) => val[0] > dayBeforeEpoch);
            }
        }

        function drawData(data, chart, xValIndex, yValIndex) {
            chart.draw(data, yValIndex);
        }

        function setSensorData(data, name) {
            const identifier = data["identifier"]
            const values = data["values"];

            gData[identifier] = {
                "name": name,
                "values": values
            };
        }

        function addSensorData(data, name) {
            const identifier = data["identifier"]
            const values = data["values"][0];

            if (gData.hasOwnProperty(identifier)) {
                gData[identifier]["values"] = gData[identifier]["values"] || [];
                gData[identifier]["values"].push(values);
            }
            else {
                setSensorData(data, name);
            }
        }

        window.addEventListener('load', function () {
            initialFetchSensorsData();
            temperatureChart.draw(gData, TEMPERATURE_IDX);
            humidityChart.draw(gData, HUMIDITY_IDX);
        })

        window.addEventListener('resize', function () {
            temperatureChart.draw(gData, TEMPERATURE_IDX);
            humidityChart.draw(gData, HUMIDITY_IDX);
        })

        if (!!window.EventSource) {
            var source = new EventSource('/events');

            source.addEventListener('open', function (e) {
                console.log("Connected");
            }, false);

            source.addEventListener('error', function (e) {
                if (e.target.readyState != EventSource.OPEN) {
                    console.log("Disconnected");
                }
            }, false);

            source.addEventListener('newReading', function (e) {
                const reading = JSON.parse(e.data);
                console.log(e.data);

                let sensorName = "Unnamed";
                if (gSensorIDsToNames.hasOwnProperty(reading.identifier)) {
                    sensorName = gSensorIDsToNames[reading.identifier];
                }

                addSensorData(reading, sensorName);

                cleanupData(gData);
                temperatureChart.draw(gData, TEMPERATURE_IDX);
                humidityChart.draw(gData, HUMIDITY_IDX);
            }, false);
        }

    </script>
</body>

</html>